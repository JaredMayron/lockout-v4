# PHPStan static analysis for the PHP web scripts (web/*.php)
# Complements the CodeQL workflow which does not support PHP.

name: "PHPStan"

on:
  workflow_dispatch:
  push:
    branches: [main]
    paths:
      - "web/**"
      - "phpstan.neon"
      - ".github/workflows/phpstan.yml"
  pull_request:
    branches: [main]
    paths:
      - "web/**"
      - "phpstan.neon"
      - ".github/workflows/phpstan.yml"

permissions:
  contents: read
  security-events: write

jobs:
  phpstan:
    name: PHPStan Analysis
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.3"
          tools: phpstan

      - name: Run PHPStan
        run: phpstan analyse --configuration=phpstan.neon --no-progress --error-format=json > phpstan.json
        continue-on-error: true

      - name: Convert PHPStan JSON to SARIF
        run: |
          python3 -c "
          import json, sys

          with open('phpstan.json') as f:
              data = json.load(f)

          rules = {}
          results = []

          for file_path, messages in data.get('files', {}).items():
              for msg in messages.get('messages', []):
                  rule_id = msg.get('identifier', 'phpstan.error')
                  if rule_id not in rules:
                      rules[rule_id] = {
                          'id': rule_id,
                          'shortDescription': {'text': rule_id},
                          'defaultConfiguration': {'level': 'warning'}
                      }
                  results.append({
                      'ruleId': rule_id,
                      'level': 'warning',
                      'message': {'text': msg.get('message', '')},
                      'locations': [{
                          'physicalLocation': {
                              'artifactLocation': {'uri': file_path, 'uriBaseId': '%SRCROOT%'},
                              'region': {'startLine': msg.get('line', 1)}
                          }
                      }]
                  })

          sarif = {
              '\$schema': 'https://json.schemastore.org/sarif-2.1.0.json',
              'version': '2.1.0',
              'runs': [{
                  'tool': {
                      'driver': {
                          'name': 'PHPStan',
                          'informationUri': 'https://phpstan.org',
                          'rules': list(rules.values())
                      }
                  },
                  'results': results
              }]
          }

          with open('phpstan.sarif', 'w') as f:
              json.dump(sarif, f, indent=2)

          print(f'Converted {len(results)} findings to SARIF')
          "

      - name: Upload results to Security tab
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: phpstan.sarif
          category: phpstan
